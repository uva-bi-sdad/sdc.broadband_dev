---
title: "generalized_ookla_download"
output: html_document
date: "2023-01-13"
---

# Reference https://github.com/teamookla/ookla-open-data/blob/master/tutorials/aggregate_by_county.md

```{r}
library(tigris) # county boundaries
library(tidyverse) # data cleaning
library(sf) # spatial functions
library(knitr)
library(kableExtra) # county statistics table
library(RColorBrewer) # colors
library(here) # file management
library(usethis) # download data
```


# Download data
```{r}
# download the zip folder from s3 and save to working directory
# use_zip("https://ookla-open-data.s3-us-west-2.amazonaws.com/shapefiles/performance/type%3Dfixed/year%3D2020/quarter%3D2/2020-04-01_performance_fixed_tiles.zip")


#read the shapefile. 
tiles <- read_sf(here("legacy/code/temp/2020-04-01_performance_fixed_tiles/gps_fixed_tiles.shp")) %>%
  mutate(avg_d_kbps = as.numeric(avg_d_kbps),
         avg_u_kbps = as.numeric(avg_u_kbps),
         avg_lat_ms = as.numeric(avg_lat_ms))
```

# Get county boundaries
```{r}
ky_counties <- tigris::counties(state = "Kentucky") %>%
  select(state_code = STATEFP, geoid = GEOID, name = NAME) %>% # only keep useful variables 
  st_transform(4326) # transform to the same CRS as the tiles
summary(ky_counties)
```

# Test Progress bars https://r-coder.com/progress-bar-r/
```{r}
# install.packages("progress")
library(progress)

```

```{r}
glimpse(tiles)
```

```{r}

```



# Join tiles to counties. Takes a long time to run, therefore I added a progress bar
Now Iâ€™ll join the tiles to the counties. I use left = FALSE because I only want to include counties that have at least 1 tile.
```{r}
tiles <- tiles[sample(nrow(tiles), 500000), ] # create smaller sample for testing
# batch = 1000
# 
# n_iter <- nrow(tiles)%/%batch # The total number of batches to iterate
# 
# n_iter
# # n_iter <- nrow(tiles)
# 
# pb <- progress_bar$new(format = "(:spin) [:bar] :percent [Elapsed time: :elapsedfull || Estimated time remaining: :eta]",
#                        total = n_iter,
#                        complete = "=",   # Completion bar character
#                        incomplete = "-", # Incomplete bar character
#                        current = ">",    # Current bar character
#                        clear = FALSE,    # If TRUE, clears the bar when finish
#                        width = 100)      # Width of the progress bar

# tiles_in_ky_counties <- NULL

# a = 1:3
# a
# a[1:6]# 1 2 3 NA NA NA

# for(i in 1:n_iter) {
#     start <- (i-1) * batch + 1
#     end <- (i * batch)
#     # print(paste(start, end, sep=' '))
#     tile_part <- tiles[start: end,]
#     tile_part <- st_join(ky_counties, tile_part)
#     if (is.null(tiles_in_ky_counties)){
#       tiles_in_ky_counties <- tile_part
#     }else{
#       tiles_in_ky_counties <- st_join(tiles_in_ky_counties, tile_part, left=FALSE)
#     }
#     pb$tick()
#     #---------------------
# }

tiles_in_ky_counties <- st_join(ky_counties, tile_part, left=FALSE)
tiles_in_ky_counties
```
```{r}
library(mapview)
mapview(tiles_in_ky_counties, zcol="avg_d_kbps")
```




